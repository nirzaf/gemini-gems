---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import GemCard from "../components/GemCard.astro";
import MuiSearchFilter from "../components/MuiSearchFilter.tsx";
import fs from "node:fs";
import path from "node:path";
import matter from "gray-matter";

const gemsDir = path.join(process.cwd(), "src", "content", "gems");
const gemFiles = fs.readdirSync(gemsDir).filter((file) => file.endsWith(".md"));

const gems = gemFiles
  .map((file, index) => {
    const slug = file.replace(/\.md$/, "");
    const filePath = path.join(gemsDir, file);
    const source = fs.readFileSync(filePath, "utf-8");
    const { data } = matter(source);

    return {
      id: (index + 1).toString(),
      slug,
      data: {
        title: data.title as string,
        description: data.description as string,
        category: data.category as string,
        icon: data.icon as string,
        color: data.color as string,
        features: Array.isArray(data.features) ? data.features : [],
        summary: data.summary as string | undefined,
        lastUpdated: data.lastUpdated
          ? new Date(data.lastUpdated as string | number | Date)
          : undefined,
      },
    };
  })
  .sort((a, b) => {
    const dateA = a.data.lastUpdated?.getTime() || 0;
    const dateB = b.data.lastUpdated?.getTime() || 0;
    return dateB - dateA;
  });

const categories = [...new Set(gems.map((gem) => gem.data.category))].sort();
---

<Layout>
  <Header />

  <!-- Gems Section -->
  <section
    id="gems"
    class="py-4 bg-gray-50 dark:bg-[#0f1419] min-h-screen transition-colors duration-300"
  >
    <div class="container mx-auto px-4">
      <div class="text-center mb-4">
        <h2
          class="text-2xl md:text-3xl font-bold mb-1 text-gray-900 dark:text-white"
        >
          Find the right expert Gem
        </h2>
        <p
          class="text-sm md:text-base max-w-2xl mx-auto text-gray-600 dark:text-gray-400"
        >
          Search, filter by category, and launch a ready-to-use AI persona.
        </p>
      </div>

      <!-- Search & Filters -->
      <div>
        <MuiSearchFilter
          client:load
          categories={categories}
          initialCount={gems.length}
        />
      </div>

      <!-- Gems Grid -->
      <div
        id="gemsGrid"
        class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"
      >
        {gems.map((gem) => <GemCard gem={gem} />)}
      </div>
    </div>
  </section>

  <Footer gemCount={gems.length} categoryCount={categories.length} />

  <!-- Load gem data client-side -->
  <script src="../lib/load-gem-data.ts"></script>
</Layout>
