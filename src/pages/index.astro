---
import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import GemCard from "../components/GemCard.astro";
import SearchFilter from "../components/SearchFilter.astro";

// Fetch all gems from database via API
let gems: any[] = [];
let categories: string[] = [];

try {
  const response = await fetch(`${Astro.url.origin}/api/gems`);
  if (response.ok) {
    const data = await response.json();
    if (data.success && data.gems) {
      gems = data.gems.map((gem: any) => {
        // Parse features if it's a string
        let features = gem.features;
        if (typeof features === "string") {
          try {
            features = JSON.parse(features);
          } catch (e) {
            console.warn(`Failed to parse features for ${gem.slug}:`, e);
            features = [];
          }
        }

        return {
          id: gem.id?.toString() || gem.slug,
          slug: gem.slug,
          data: {
            title: gem.title || "Untitled",
            description: gem.description || "",
            category: gem.category || "General",
            icon: gem.icon || "file",
            color: gem.color || "bg-gray-500",
            features: Array.isArray(features) ? features : [],
            lastUpdated: gem.lastUpdated
              ? new Date(gem.lastUpdated)
              : new Date(),
          },
        };
      });

      // Sort by lastUpdated
      gems.sort((a, b) => {
        const dateA = a.data.lastUpdated?.getTime() || 0;
        const dateB = b.data.lastUpdated?.getTime() || 0;
        return dateB - dateA;
      });

      // Get unique categories
      categories = [...new Set(gems.map((gem) => gem.data.category))].sort();
    }
  }
} catch (error) {
  console.error("Failed to fetch gems from database:", error);
}

console.log("ðŸ“Š Loaded", gems.length, "gems from database");
---

<Layout>
  <Header />

  <!-- Stats Section -->
  <section class="py-8 bg-[#0f1419] transition-colors duration-300">
    <div class="container mx-auto px-4">
      <div
        class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center max-w-4xl mx-auto"
      >
        <div
          class="stats-card p-5 rounded-xl shadow-sm hover:shadow-md transition-shadow"
        >
          <div
            class="text-3xl md:text-4xl font-bold bg-gradient-to-r from-blue-400 to-cyan-400 bg-clip-text text-transparent mb-2"
          >
            {gems.length}
          </div>
          <div class="text-gray-400 font-semibold text-sm">Gems</div>
        </div>
        <div
          class="stats-card p-5 rounded-xl shadow-sm hover:shadow-md transition-shadow"
        >
          <div
            class="text-3xl md:text-4xl font-bold bg-gradient-to-r from-teal-400 to-emerald-400 bg-clip-text text-transparent mb-2"
          >
            {categories.length}
          </div>
          <div class="text-gray-400 font-semibold text-sm">Categories</div>
        </div>
        <div
          class="stats-card p-5 rounded-xl shadow-sm hover:shadow-md transition-shadow"
        >
          <div
            class="text-3xl md:text-4xl font-bold bg-gradient-to-r from-slate-400 to-gray-400 bg-clip-text text-transparent mb-2"
          >
            100%
          </div>
          <div class="text-gray-400 font-semibold text-sm">Open Source</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Gems Section -->
  <section
    id="gems"
    class="py-12 bg-[#0f1419] min-h-screen transition-colors duration-300"
  >
    <div class="container mx-auto px-4">
      <div class="text-center mb-8">
        <h2 class="text-3xl md:text-4xl font-bold mb-3 text-white">
          Find the right expert Gem
        </h2>
        <p class="text-base md:text-lg max-w-2xl mx-auto text-gray-400">
          Search, filter by category, and launch a ready-to-use AI persona.
        </p>
      </div>

      <!-- Search & Filters -->
      <div class="sticky top-4 z-20">
        <SearchFilter categories={categories} initialCount={gems.length} />
      </div>

      <!-- Gems Grid -->
      <div
        id="gemsGrid"
        class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"
      >
      {gems.map((gem) => (
        <GemCard gem={gem} />
      ))}
      </div>
    </div>
  </section>

  <Footer />

  <!-- Load gem data client-side -->
  <script src="../lib/load-gem-data.ts"></script>
</Layout>
