import Layout from "../layouts/Layout.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import GemCard from "../components/GemCard.astro";
import SearchFilter from "../components/SearchFilter.astro";
import { db } from "../db";
import { gems as gemsSchema } from "../db/schema";

// Fetch gems from database
if (!db) {
  throw new Error("Database connection not available");
}
const dbGems = await db.select().from(gemsSchema);

// Map DB gems to the format expected by GemCard
const gems = dbGems
  .map((gem) => ({
    id: gem.id.toString(),
    slug: gem.slug,
    data: {
      title: gem.title,
      description: gem.description,
      category: gem.category,
      icon: gem.icon,
      color: gem.color,
      features: JSON.parse(gem.features),
      lastUpdated: gem.lastUpdated,
    },
  }))
  .sort((a, b) => {
    const dateA = a.data.lastUpdated?.getTime() || 0;
    const dateB = b.data.lastUpdated?.getTime() || 0;
    return dateB - dateA;
  });

const categories = [...new Set(gems.map((gem) => gem.data.category))].sort();
---

<Layout>
  <Header />

  <!-- Stats Section -->
  <section
    class="py-8 bg-gray-50 dark:bg-[#0f1419] transition-colors duration-300"
  >
    <div class="container mx-auto px-4">
      <div
        class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center max-w-4xl mx-auto"
      >
        <div
          class="stats-card p-5 rounded-xl shadow-sm hover:shadow-md transition-shadow"
        >
          <div
            class="text-3xl md:text-4xl font-bold bg-gradient-to-r from-blue-400 to-cyan-400 bg-clip-text text-transparent mb-2"
          >
            {gems.length}
          </div>
          <div class="text-gray-600 dark:text-gray-400 font-semibold text-sm">
            Gems
          </div>
        </div>
        <div
          class="stats-card p-5 rounded-xl shadow-sm hover:shadow-md transition-shadow"
        >
          <div
            class="text-3xl md:text-4xl font-bold bg-gradient-to-r from-teal-400 to-emerald-400 bg-clip-text text-transparent mb-2"
          >
            {categories.length}
          </div>
          <div class="text-gray-600 dark:text-gray-400 font-semibold text-sm">
            Categories
          </div>
        </div>
        <div
          class="stats-card p-5 rounded-xl shadow-sm hover:shadow-md transition-shadow"
        >
          <div
            class="text-3xl md:text-4xl font-bold bg-gradient-to-r from-slate-400 to-gray-400 bg-clip-text text-transparent mb-2"
          >
            100%
          </div>
          <div class="text-gray-600 dark:text-gray-400 font-semibold text-sm">
            Open Source
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Gems Section -->
  <section
    id="gems"
    class="py-12 bg-gray-50 dark:bg-[#0f1419] min-h-screen transition-colors duration-300"
  >
    <div class="container mx-auto px-4">
      <div class="text-center mb-8">
        <h2
          class="text-3xl md:text-4xl font-bold mb-3 text-gray-900 dark:text-white"
        >
          Find the right expert Gem
        </h2>
        <p
          class="text-base md:text-lg max-w-2xl mx-auto text-gray-600 dark:text-gray-400"
        >
          Search, filter by category, and launch a ready-to-use AI persona.
        </p>
      </div>

      <!-- Search & Filters -->
      <div class="sticky top-4 z-20">
        <SearchFilter categories={categories} initialCount={gems.length} />
      </div>

      <!-- Gems Grid -->
      <div
        id="gemsGrid"
        class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"
      >
        {gems.map((gem) => <GemCard gem={gem} />)}
      </div>
    </div>
  </section>

  <Footer />

  <!-- Load gem data client-side -->
  <script src="../lib/load-gem-data.ts"></script>
</Layout>
