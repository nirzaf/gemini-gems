---
import { Eye, Download, Copy } from 'lucide-astro';

interface Props {
  gem: {
    id: string;
    slug: string;
    data: {
      title: string;
      description: string;
      category: string;
      icon: string;
      color: string;
      features: string[];
    };
  };
}

const { gem } = Astro.props;

// Map category to Font Awesome icon classes
const categoryIcons: Record<string, string> = {
  'Education': 'fas fa-graduation-cap',
  'Development': 'fas fa-code',
  'Business': 'fas fa-briefcase',
  'Creative': 'fas fa-palette',
  'Spiritual': 'fas fa-heart',
  'Lifestyle': 'fas fa-home',
  'Finance': 'fas fa-dollar-sign',
  'Wellness': 'fas fa-heartbeat'
};

const categoryIcon = categoryIcons[gem.data.category] || 'fas fa-tag';
---

<div
  class="gem-card rounded-xl p-4 shadow-lg flex flex-col h-full"
  data-title={gem.data.title}
  data-description={gem.data.description}
  data-category={gem.data.category}
  data-features={gem.data.features.join(' ')}
>
  <!-- Icon, Title and Quick Action -->
  <div class="flex items-center gap-3 mb-3">
    <div class={`w-10 h-10 rounded-lg flex items-center justify-center shadow-md flex-shrink-0 ${gem.data.color}`}>
      <i class={`${categoryIcon} text-base text-white`}></i>
    </div>
    <h3 class="text-sm font-bold text-white flex-1 line-clamp-2 leading-tight">{gem.data.title}</h3>
    <button
      data-gem-slug={gem.data.slug}
      class="copy-gem-btn p-2 rounded-md bg-white/10 border border-white/20 text-white hover:bg-white/20 transition inline-flex items-center justify-center focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-white/40"
      title="Copy gem content"
      aria-label="Copy gem content"
    >
      <Copy class="w-3.5 h-3.5" />
    </button>
  </div>

  <!-- Category Badge -->
  <div class="mb-3">
    <span class={`inline-block px-2 py-0.5 text-xs font-semibold rounded ${gem.data.color} bg-opacity-20 text-white border border-current border-opacity-30`}>
      {gem.data.category}
    </span>
  </div>

  <!-- Description -->
  <p class="text-xs leading-relaxed mb-3 text-gray-400 line-clamp-2">{gem.data.description}</p>

  <!-- Key Features -->
  <div class="mb-4 flex-grow">
    <h4 class="text-xs font-bold text-white mb-2">Key Features:</h4>
    <ul class="space-y-1">
      {gem.data.features.slice(0, 3).map((feature) => (
        <li class="text-xs text-gray-400 leading-snug line-clamp-1">â€¢ {feature}</li>
      ))}
    </ul>
  </div>

  <!-- Action Buttons -->
  <div class="flex gap-1.5 mt-auto">
    <a
      href={`/gems/${gem.data.slug}`}
      class="flex-1 bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-2.5 py-1.5 rounded-lg text-center text-xs font-bold hover:from-blue-700 hover:to-indigo-700 transition-all shadow-md inline-flex items-center justify-center gap-1 ring-1 ring-white/20 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-indigo-400"
    >
      <Eye class="w-3 h-3" />
      <span>Preview</span>
    </a>
    <a
      href={`https://raw.githubusercontent.com/nirzaf/gemini-gems/main/${gem.data.slug}.md`}
      target="_blank"
      class="flex-1 bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-2.5 py-1.5 rounded-lg text-center text-xs font-bold hover:from-indigo-700 hover:to-purple-700 transition-all shadow-md inline-flex items-center justify-center gap-1 ring-1 ring-white/20 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-purple-400"
    >
      <Download class="w-3 h-3" />
      <span>Get</span>
    </a>
  </div>
</div>

<!-- Font Awesome for category icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

<script>
  // Copy gem content functionality
  document.addEventListener('DOMContentLoaded', () => {
    const copyButtons = document.querySelectorAll('.copy-gem-btn');
    
    copyButtons.forEach(button => {
      button.addEventListener('click', async () => {
        const slug = button.getAttribute('data-gem-slug');
        if (!slug) return;
        
        try {
          // Fetch the raw markdown content
          const response = await fetch(`https://raw.githubusercontent.com/nirzaf/gemini-gems/main/${slug}.md`);
          const content = await response.text();
          
          // Copy to clipboard
          await navigator.clipboard.writeText(content);
          
          // Show success feedback
          const originalText = button.innerHTML;
          button.innerHTML = '<svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg><span>Copied!</span>';
          button.classList.add('bg-gradient-to-r', 'from-green-500', 'to-emerald-500');
          
          setTimeout(() => {
            button.innerHTML = originalText;
            button.classList.remove('from-green-500', 'to-emerald-500');
          }, 2000);
        } catch (error) {
          console.error('Failed to copy:', error);
          alert('Failed to copy content. Please try again.');
        }
      });
    });
  });
</script>
