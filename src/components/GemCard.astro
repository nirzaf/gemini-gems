---
import { Eye, Download, Copy, TrendingUp } from "lucide-astro";

interface Props {
  gem: {
    id: string;
    slug: string;
    data: {
      title: string;
      description: string;
      category: string;
      icon: string;
      color: string;
      features: string[];
      summary?: string;
    };
  };
}

const { gem } = Astro.props;

// Map category to Font Awesome icon classes
const categoryIcons: Record<string, string> = {
  Education: "fas fa-graduation-cap",
  Development: "fas fa-code",
  Business: "fas fa-briefcase",
  Creative: "fas fa-palette",
  Spiritual: "fas fa-heart",
  Lifestyle: "fas fa-home",
  Finance: "fas fa-dollar-sign",
  Wellness: "fas fa-heartbeat",
};

const categoryIcon = categoryIcons[gem.data.category] || "fas fa-tag";
const hasSummary = !!gem.data.summary;
---

<div
  class="gem-card relative rounded-xl p-4 shadow-lg flex flex-col h-full bg-white dark:bg-white/5 border border-gray-300 dark:border-white/10 transition-colors duration-300"
  data-title={gem.data.title}
  data-description={gem.data.description}
  data-category={gem.data.category}
  data-features={gem.data.features.join(" ")}
  data-gem-slug={gem.slug}
  data-has-summary={hasSummary ? "true" : "false"}
>
  <!-- Icon and Title -->
  <div class="flex items-center gap-3 mb-3">
    <div
      class={`w-10 h-10 rounded-lg flex items-center justify-center shadow-md flex-shrink-0 ${gem.data.color}`}
    >
      <i class={`${categoryIcon} text-base text-white`}></i>
    </div>
    <h3
      class="text-sm font-bold text-gray-900 dark:text-white flex-1 line-clamp-2 leading-tight"
    >
      {gem.data.title}
    </h3>
  </div>

  <!-- Category Badge -->
  <div class="mb-3 flex items-center gap-2 flex-wrap">
    <span
      class={`inline-block px-2.5 py-1 text-xs font-bold rounded-md ${gem.data.color} bg-opacity-100 dark:bg-opacity-20 text-white border-2 ${gem.data.color} border-opacity-100 dark:border-opacity-30`}
    >
      {gem.data.category}
    </span>
    <!-- Copy count and labels will be added dynamically via client-side script -->
  </div>

  <!-- Tab Buttons for Copy Content Type -->
  <div class="mb-3 flex items-center gap-1">
    <button
      data-tab="full"
      data-gem-slug={gem.slug}
      class="tab-btn active-tab flex-1 px-2 py-1.5 text-xs font-semibold rounded-l-md border border-gray-300 dark:border-white/20 bg-blue-600 text-white transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500"
      title="Copy full gem content"
    >
      <span class="flex items-center justify-center gap-1">
        <Copy class="w-3 h-3" />
        Full
      </span>
    </button>
    <button
      data-tab="summary"
      data-gem-slug={gem.slug}
      class={`tab-btn flex-1 px-2 py-1.5 text-xs font-semibold rounded-r-md border border-gray-300 dark:border-white/20 transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 ${hasSummary ? "bg-gray-100 dark:bg-white/10 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-white/20" : "bg-gray-50 dark:bg-white/5 text-gray-400 dark:text-gray-600 cursor-not-allowed opacity-50"}`}
      title={hasSummary
        ? "Copy summarized version (125-150 words)"
        : "Summary not available"}
      disabled={!hasSummary}
    >
      <span class="flex items-center justify-center gap-1">
        <Copy class="w-3 h-3" />
        Summary
      </span>
    </button>
  </div>

  <!-- Description -->
  <p
    class="text-xs leading-relaxed mb-3 text-gray-600 dark:text-gray-400 line-clamp-2"
  >
    {gem.data.description}
  </p>

  <!-- Key Features -->
  <div class="mb-4 flex-grow">
    <h4 class="text-xs font-bold text-gray-900 dark:text-white mb-2">
      Key Features:
    </h4>
    <ul class="space-y-1">
      {
        gem.data.features
          .slice(0, 3)
          .map((feature) => (
            <li class="text-xs text-gray-700 dark:text-gray-400 leading-snug line-clamp-1">
              â€¢ {feature}
            </li>
          ))
      }
    </ul>
  </div>

  <!-- Action Buttons -->
  <div class="flex gap-1.5 mt-auto">
    <a
      href={`/gems/${gem.slug}`}
      class="flex-1 bg-gradient-to-r from-blue-700 to-cyan-600 text-white px-2.5 py-1.5 rounded-lg text-center text-xs font-bold hover:from-blue-800 hover:to-cyan-700 transition-all shadow-md inline-flex items-center justify-center gap-1 ring-1 ring-white/20 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-cyan-400"
    >
      <Eye class="w-3 h-3" />
      <span>Preview</span>
    </a>
    <a
      href={`https://raw.githubusercontent.com/nirzaf/gemini-gems/main/src/content/gems/${gem.slug}.md`}
      target="_blank"
      class="flex-1 bg-gradient-to-r from-blue-700 to-cyan-600 text-white px-2.5 py-1.5 rounded-lg text-center text-xs font-bold hover:from-blue-800 hover:to-cyan-700 transition-all shadow-md inline-flex items-center justify-center gap-1 ring-1 ring-white/20 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-cyan-400"
    >
      <Download class="w-3 h-3" />
      <span>Get</span>
    </a>
  </div>
</div>

<!-- Font Awesome for category icons -->
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
/>

<script>
  // Tab-based copy gem content functionality
  function initTabCopyButtons() {
    // Track active tab per card
    const activeTabMap = new Map<string, string>();

    // Use event delegation for better performance and handling dynamic content
    document.body.addEventListener("click", async (e) => {
      const target = e.target as HTMLElement;
      const button = target.closest(".tab-btn") as HTMLButtonElement;

      if (!button) return;
      if (button.disabled) return;

      const slug = button.getAttribute("data-gem-slug");
      const tabType = button.getAttribute("data-tab");
      if (!slug || !tabType) return;

      // Find the parent card
      const card = button.closest(".gem-card");
      if (!card) return;

      // Update active tab styling
      const allTabBtns = card.querySelectorAll(".tab-btn");
      allTabBtns.forEach((btn) => {
        const btnTab = btn.getAttribute("data-tab");
        if (btnTab === tabType) {
          btn.classList.add("active-tab", "bg-blue-600", "text-white");
          btn.classList.remove(
            "bg-gray-100",
            "dark:bg-white/10",
            "text-gray-700",
            "dark:text-gray-300",
            "hover:bg-gray-200",
            "dark:hover:bg-white/20",
          );
        } else if (!btn.hasAttribute("disabled")) {
          btn.classList.remove("active-tab", "bg-blue-600", "text-white");
          btn.classList.add(
            "bg-gray-100",
            "dark:bg-white/10",
            "text-gray-700",
            "dark:text-gray-300",
            "hover:bg-gray-200",
            "dark:hover:bg-white/20",
          );
        }
      });

      // Store active tab
      activeTabMap.set(slug, tabType);

      // Prevent multiple clicks while processing
      if (button.getAttribute("data-processing") === "true") return;
      button.setAttribute("data-processing", "true");

      try {
        // Fetch content from local static API
        const base = import.meta.env.BASE_URL.replace(/\/$/, "");
        const response = await fetch(`${base}/api/content/${slug}.json`);

        if (!response.ok) throw new Error("Failed to fetch content");

        const data = await response.json();

        // Copy the appropriate content based on tab
        const contentToCopy =
          tabType === "summary" && data.summary ? data.summary : data.content;

        await navigator.clipboard.writeText(contentToCopy);

        // Show success feedback
        const originalHTML = button.innerHTML;
        button.innerHTML =
          '<span class="flex items-center justify-center gap-1"><svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>Copied!</span>';
        button.classList.add("bg-green-500", "border-green-400");

        setTimeout(() => {
          button.innerHTML = originalHTML;
          button.classList.remove("bg-green-500", "border-green-400");
          // Restore active tab styling
          if (activeTabMap.get(slug) === tabType) {
            button.classList.add("bg-blue-600", "text-white");
          }
          button.removeAttribute("data-processing");
        }, 2000);
      } catch (error) {
        console.error("Failed to copy:", error);
        alert("Failed to copy content. Please try again.");
        button.removeAttribute("data-processing");
      }
    });
  }

  // Initialize once
  if (!(window as any).hasInitTabCopyButtons) {
    (window as any).hasInitTabCopyButtons = true;
    initTabCopyButtons();
  }
</script>
